Option Explicit

' 再帰的にフォルダを作成するヘルパー
Private Sub CreateFoldersRecursive(ByVal folderPath As String)
    Dim fso As Object
    Dim parentPath As String
    
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    If fso.FolderExists(folderPath) Then Exit Sub
    
    parentPath = Left(folderPath, InStrRev(folderPath, "\") - 1)
    If Len(parentPath) > 0 And Not fso.FolderExists(parentPath) Then
        ' 親が存在しない場合は先に作成
        CreateFoldersRecursive parentPath
    End If
    
    fso.CreateFolder folderPath
End Sub

' 任意の範囲をCSVとしてUTF-8で出力（再帰フォルダ作成対応）
Sub ExportRangeToCSV_UTF8()
    Dim ws As Worksheet
    Dim rng As Range
    Dim csvFile As String
    Dim folderPath As String
    Dim stream As Object
    Dim r As Long, c As Long
    Dim lineText As String
    
    '=== 設定 ===
    Set ws = ThisWorkbook.Sheets("Sheet1")   ' 対象シート
    Set rng = ws.Range("A1:C10")             ' 出力範囲
    csvFile = Environ("USERPROFILE") & "\Documents\Export\CSV\2025\RangeExport.csv"
    
    '=== 保存先フォルダを再帰的に作成 ===
    folderPath = Left(csvFile, InStrRev(csvFile, "\") - 1)
    CreateFoldersRecursive folderPath
    
    '=== UTF-8で書き出し ===
    Set stream = CreateObject("ADODB.Stream")
    With stream
        .Type = 2
        .Charset = "UTF-8"
        .Open
        
        For r = 1 To rng.Rows.Count
            lineText = ""
            For c = 1 To rng.Columns.Count
                lineText = lineText & """" & rng.Cells(r, c).Text & """"
                If c < rng.Columns.Count Then lineText = lineText & ","
            Next c
            .WriteText lineText, 1
        Next r
        
        .SaveToFile csvFile, 2
        .Close
    End With
    
    MsgBox "範囲 " & rng.Address & " をUTF-8 CSVに出力しました。" & vbCrLf & csvFile, vbInformation
End Sub
